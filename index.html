<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ISA Portfolio · FT Data</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --ink: #0e0f0f;
    --paper: #f5f0e8;
    --paper2: #ede7d9;
    --rule: #c8bfaa;
    --muted: #9a9080;
    --up: #1f6b42;
    --up-bg: #e6f2ec;
    --down: #8f2a1a;
    --down-bg: #f5e9e6;
    --flat: #7a7060;
  }

  /* Category palette */
  :root {
    --c-industrials: #2d4a6b;
    --c-realestate:  #6b3a2d;
    --c-invtrusts:   #2d5a3a;
    --c-resources:   #5a3d1a;
    --c-renewables:  #1a5a4a;
    --c-banks:       #3d2d6b;
    --c-assetmgr:    #5a1a4a;
    --c-insurance:   #3d5a2d;
    --c-healthcare:  #6b2d4a;
    --c-infra:       #2d4a5a;
    --c-etfs:        #5a5a1a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'Outfit', sans-serif;
    font-weight: 300;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 100;
    opacity: 0.5;
  }

  .page {
    max-width: 960px;
    margin: 0 auto;
    padding: 60px 24px 80px;
  }

  /* ── MASTHEAD ── */
  .masthead {
    border-top: 3px solid var(--ink);
    border-bottom: 1px solid var(--rule);
    padding: 20px 0 18px;
    margin-bottom: 0;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: end;
    gap: 16px;
  }

  .masthead-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 50px;
    font-weight: 300;
    letter-spacing: -1px;
    line-height: 1;
  }

  .masthead-title em { font-style: italic; color: #5a3d1a; }

  .masthead-meta {
    text-align: right;
    font-size: 12px;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--muted);
    line-height: 2;
  }

  .subtitle-bar {
    border-bottom: 3px solid var(--ink);
    padding: 10px 0 12px;
    margin-bottom: 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .subtitle-bar .desc {
    font-family: 'Cormorant Garamond', serif;
    font-size: 17px;
    font-weight: 300;
    font-style: italic;
    color: var(--muted);
  }

  .last-updated-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--up);
    background: var(--up-bg);
    border: 1px solid rgba(31,107,66,0.2);
    border-radius: 2px;
    padding: 3px 10px;
    margin-top: 5px;
  }
  .last-updated-badge::before {
    content: '';
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--up);
    animation: blink 2s infinite;
  }
  @keyframes blink {
    0%,100% { opacity: 1; }
    50%      { opacity: 0.25; }
  }
    font-size: 12px;
    letter-spacing: 0.13em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: right;
    line-height: 1.7;
  }

  /* ── SECTION LABELS ── */
  .section-label {
    font-size: 12px;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--rule);
  }

  /* ── TODAY'S SCORECARD ── */
  .scorecard {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1px;
    background: var(--rule);
    border: 1px solid var(--rule);
    margin-bottom: 40px;
  }

  .score-cell {
    background: var(--paper);
    padding: 18px 16px;
  }

  .score-cell-label {
    font-size: 12px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .score-cell-val {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(28px, 5vw, 36px);
    font-weight: 300;
    line-height: 1;
  }

  .score-cell-val.up   { color: var(--up); }
  .score-cell-val.down { color: var(--down); }
  .score-cell-val.neutral { color: var(--ink); }

  .score-cell-sub {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* ── MOSAIC STRIP ── */
  .mosaic-section { margin-bottom: 40px; }

  .mosaic-strip {
    display: flex;
    height: 44px;
    width: 100%;
    gap: 2px;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 14px;
  }

  .mosaic-seg {
    height: 100%;
    position: relative;
    transition: filter 0.2s;
    cursor: default;
  }

  .mosaic-seg:hover { filter: brightness(1.2); }

  .mosaic-seg::after {
    content: attr(data-label);
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--ink);
    color: var(--paper);
    font-size: 12px;
    padding: 4px 10px;
    white-space: nowrap;
    border-radius: 2px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    letter-spacing: 0.04em;
    z-index: 10;
  }

  .mosaic-seg:hover::after { opacity: 1; }

  /* ── LEGEND ── */
  .legend-strip {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    padding: 14px 18px;
    background: var(--paper2);
    border: 1px solid var(--rule);
    margin-bottom: 40px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 12px;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .legend-swatch {
    width: 11px;
    height: 11px;
    border-radius: 1px;
    flex-shrink: 0;
  }

  /* ── SECTOR CHART ── */
  .sector-chart-section { margin-bottom: 40px; }

  .sector-chart-wrap {
    display: flex;
    align-items: center;
    gap: 32px;
    flex-wrap: wrap;
  }

  .sector-chart-canvas-wrap {
    position: relative;
    width: 180px;
    height: 180px;
    flex-shrink: 0;
  }

  @media (max-width: 600px) {
    .sector-chart-canvas-wrap { width: 140px; height: 140px; }
    .sector-chart-wrap { gap: 20px; justify-content: center; }
  }

  .sector-legend-list { flex: 1; min-width: 160px; }

  .sector-legend-item {
    display: flex;
    align-items: center;
    gap: 9px;
    margin-bottom: 7px;
    font-size: 13px;
    letter-spacing: 0.04em;
  }

  .sector-legend-swatch {
    width: 10px;
    height: 10px;
    border-radius: 1px;
    flex-shrink: 0;
  }

  .sector-legend-name { flex: 1; color: var(--ink); }

  .sector-legend-detail {
    color: var(--muted);
    font-family: 'Cormorant Garamond', serif;
    font-size: 13px;
  }

  /* keep cat-grid for smaller mobile fallback */
  .cat-grid {
    display: none; /* replaced by chart */
  }

  .cat-cell {
    background: var(--paper);
    padding: 16px 18px;
  }

  .cat-swatch {
    width: 20px;
    height: 3px;
    border-radius: 1px;
    margin-bottom: 8px;
  }

  .cat-name {
    font-size: 12px;
    letter-spacing: 0.13em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 5px;
  }

  .cat-count {
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 300;
    line-height: 1;
    color: var(--ink);
  }

  .cat-count span { font-size: 13px; color: var(--muted); }

  .cat-move {
    font-size: 12px;
    color: var(--muted);
    margin-top: 3px;
  }

  /* ── MOVERS COLUMNS ── */
  .movers-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 40px;
  }

  .movers-col {
    background: var(--paper);
    border: 1px solid var(--rule);
  }

  .movers-head {
    padding: 12px 16px;
    border-bottom: 1px solid var(--rule);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .movers-head-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .movers-head-label {
    font-size: 12px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .mover-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 8px 16px;
    border-bottom: 1px solid rgba(200,191,170,0.35);
  }

  .mover-row:last-child { border-bottom: none; }

  .mover-name {
    font-size: clamp(14px, 2.5vw, 15px);
    font-weight: 400;
    color: var(--ink);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mover-sym {
    font-size: 12px;
    color: var(--muted);
    display: block;
    margin-top: 1px;
  }

  .mover-pct {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(18px, 3vw, 22px);
    font-weight: 600;
    white-space: nowrap;
  }

  .mover-pct.up   { color: var(--up); }
  .mover-pct.down { color: var(--down); }

  /* ── HEAT MAP ── */
  .heat-section { margin-bottom: 40px; }

  .heat-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
  }

  /* Mobile: vertical treemap stack */
  @media (max-width: 600px) {
    .heat-grid {
      flex-direction: column;
      gap: 2px;
    }
    .heat-cell {
      width: 100% !important;
      height: 36px !important;
      flex-direction: row;
      justify-content: space-between;
      padding: 0 12px;
      border-radius: 3px;
    }
    .heat-cell .heat-pct {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }
  }

  .heat-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 2px;
    padding: 3px 6px;
    cursor: default;
    transition: filter 0.15s, transform 0.12s;
    position: relative;
  }

  .heat-cell:hover {
    filter: brightness(1.15);
    z-index: 5;
    transform: scale(1.06);
  }

  .heat-pct {
    display: none; /* shown on mobile only via media query */
  }

  /* Rich floating tooltip (replaces ::after pseudo) */
  #heatTooltip {
    position: fixed;
    background: var(--ink);
    color: var(--paper);
    border: 1px solid rgba(200,191,170,0.3);
    border-radius: 4px;
    padding: 10px 14px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 200;
    min-width: 160px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    font-family: 'Outfit', sans-serif;
  }
  #heatTooltip.visible { opacity: 1; }
  #heatTooltip .ht-symbol {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-weight: 300;
    line-height: 1;
    margin-bottom: 2px;
  }
  #heatTooltip .ht-name {
    font-size: 12px;
    color: rgba(245,240,232,0.6);
    letter-spacing: 0.04em;
    margin-bottom: 6px;
  }
  #heatTooltip .ht-pct {
    font-family: 'Cormorant Garamond', serif;
    font-size: 26px;
    font-weight: 300;
    line-height: 1;
  }
  #heatTooltip .ht-pct.up   { color: #5fdb8a; }
  #heatTooltip .ht-pct.down { color: #f08080; }
  #heatTooltip .ht-price {
    font-size: 12px;
    color: rgba(245,240,232,0.55);
    margin-top: 4px;
  }
  #heatTooltip .ht-cat {
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.4);
    margin-top: 3px;
  }
  
    font-size: clamp(10px, 1.6vw, 12px);
    font-weight: 600;
    letter-spacing: 0.03em;
    color: rgba(255,255,255,0.95);
    text-align: center;
    line-height: 1;
  }

  /* ── FULL LIST ── */
  .list-section { margin-bottom: 40px; }

  .bar-row {
    display: grid;
    grid-template-columns: 22px 1fr 70px 50px;
    align-items: center;
    gap: 10px;
    padding: 5px 0;
    border-bottom: 1px solid rgba(200,191,170,0.4);
    animation: fadeRow 0.3s ease both;
  }

  @keyframes fadeRow {
    from { opacity: 0; transform: translateX(-6px); }
    to   { opacity: 1; transform: none; }
  }

  .bar-row:last-child { border-bottom: none; }

  .rank-num {
    font-family: 'Cormorant Garamond', serif;
    font-size: 12px;
    color: var(--muted);
    text-align: right;
  }

  .bar-name {
    font-size: clamp(13px, 2vw, 14px);
    font-weight: 400;
    color: var(--ink);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
  }

  .bar-name .sym {
    display: block;
    font-size: 12px;
    color: var(--muted);
    font-weight: 300;
    margin-top: 2px;
  }

  .bar-track {
    width: 70px;
    height: 6px;
    background: var(--paper2);
    border-radius: 3px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .bar-fill {
    height: 100%;
    border-radius: 3px;
  }

  .bar-chg {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(15px, 2.5vw, 17px);
    font-weight: 600;
    text-align: right;
    white-space: nowrap;
  }

  .bar-chg.up   { color: var(--up); }
  .bar-chg.down { color: var(--down); }
  .bar-chg.flat { color: var(--flat); }

  /* ── SUSPENDED BANNER ── */
  .suspended-banner {
    background: var(--paper2);
    border: 1px solid var(--rule);
    border-left: 3px solid #8f2a1a;
    padding: 14px 18px;
    margin-bottom: 40px;
    font-size: 12px;
    line-height: 1.7;
    color: var(--muted);
  }

  .suspended-banner strong {
    color: var(--down);
    font-weight: 500;
  }

  /* ── FOOTER ── */
  .footer {
    border-top: 1px solid var(--rule);
    padding-top: 18px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .footer-left {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-style: italic;
    font-weight: 300;
    color: var(--muted);
  }

  .footer-right {
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: right;
    line-height: 2;
  }

  /* ── FILTER BAR ── */
  .filter-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .filter-btn {
    font-family: 'Outfit', sans-serif;
    font-size: 12px;
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 4px 12px;
    border: 1px solid var(--rule);
    background: var(--paper);
    color: var(--muted);
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }

  .filter-btn:hover,
  .filter-btn.active {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
  }

  /* ── CSV UPLOADER ── */
  .uploader-section {
    margin-top: 56px;
    margin-bottom: 0;
  }

  .uploader-box {
    border: 2px dashed var(--rule);
    border-radius: 3px;
    padding: 32px 24px;
    text-align: center;
    background: var(--paper2);
    transition: border-color 0.2s, background 0.2s;
    cursor: pointer;
    position: relative;
  }

  .uploader-box.drag-over {
    border-color: var(--ink);
    background: #ede7d0;
  }

  .uploader-box input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .uploader-icon {
    font-size: 28px;
    margin-bottom: 10px;
    opacity: 0.4;
  }

  .uploader-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 20px;
    font-weight: 300;
    color: var(--ink);
    margin-bottom: 6px;
  }

  .uploader-sub {
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    line-height: 1.8;
  }

  .uploader-sub a {
    color: var(--ink);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .uploader-status {
    margin-top: 14px;
    font-size: 12px;
    color: var(--muted);
    min-height: 18px;
  }

  .uploader-status.ok   { color: var(--up); }
  .uploader-status.err  { color: var(--down); }

  /* ── DISCLAIMER ── */
  .disclaimer {
    margin-top: 32px;
    padding: 18px 20px;
    border-top: 1px solid var(--rule);
    border-bottom: 1px solid var(--rule);
    background: var(--paper2);
    font-size: 12px;
    color: var(--muted);
    line-height: 1.8;
    letter-spacing: 0.02em;
  }

  .disclaimer strong {
    font-weight: 500;
    color: #6b4a2d;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 12px;
    display: block;
    margin-bottom: 5px;
  }

  @media (max-width: 600px) {
    .page { padding: 24px 14px 48px; }
    .masthead { grid-template-columns: 1fr; gap: 8px; }
    .masthead-meta { text-align: left; }
    .masthead-title { font-size: clamp(26px, 8vw, 38px); }
    .scorecard { grid-template-columns: repeat(2, 1fr); }
    .scorecard .score-cell:last-child { grid-column: span 2; }
    .cat-grid { grid-template-columns: repeat(2, 1fr); }
    .movers-grid { grid-template-columns: 1fr; }
    .bar-row { grid-template-columns: 18px 1fr 44px 52px; gap: 6px; }
    .subtitle-bar { flex-direction: column; align-items: flex-start; gap: 4px; }
    .filter-btn { font-size: 12px; padding: 6px 12px; }
    .mosaic-strip { height: 32px; }
    .legend-strip { gap: 10px; padding: 10px 14px; }
    .legend-item { font-size: 12px; }
  }
</style>
</head>
<body>
<div id="heatTooltip">
  <div class="ht-symbol" id="ht-sym"></div>
  <div class="ht-name" id="ht-name"></div>
  <div class="ht-pct" id="ht-pct"></div>
  <div class="ht-price" id="ht-price"></div>
  <div class="ht-cat" id="ht-cat"></div>
</div>
<div class="page">

  <!-- MASTHEAD -->
  <div class="masthead">
    <div class="masthead-title">SIPP Portfolio <em>Overview</em></div>
    <div class="masthead-meta" id="mastheadMeta">
      91 Holdings · LSE<br>
      Price data: FT<br>
      24 Feb 2026
      <div class="last-updated-badge" id="lastUpdatedBadge">Data from file</div>
    </div>
  </div>
  <div class="subtitle-bar">
    <div class="desc">Today's movements across all holdings</div>
    <div class="right" id="subtitleRight"></div>
  </div>

  <!-- SCORECARD -->
  <div class="section-label">Today at a glance</div>
  <div class="scorecard" id="scorecard"></div>

  <!-- MOSAIC STRIP (category) -->
  <div class="mosaic-section">
    <div class="section-label">Portfolio composition by category</div>
    <div class="mosaic-strip" id="mosaicStrip"></div>
    <div class="legend-strip" id="legendStrip"></div>
  </div>

  <!-- MOVERS -->
  <div class="section-label">Notable movers today</div>
  <div class="movers-grid">
    <div class="movers-col">
      <div class="movers-head">
        <div class="movers-head-dot" style="background:var(--up)"></div>
        <div class="movers-head-label">Top gainers</div>
      </div>
      <div id="gainers"></div>
    </div>
    <div class="movers-col">
      <div class="movers-head">
        <div class="movers-head-dot" style="background:var(--down)"></div>
        <div class="movers-head-label">Biggest fallers</div>
      </div>
      <div id="losers"></div>
    </div>
  </div>

  <!-- SECTOR CHART -->
  <div class="sector-chart-section">
    <div class="section-label">Holdings by sector</div>
    <div class="sector-chart-wrap">
      <div class="sector-chart-canvas-wrap">
        <canvas id="sectorChart"></canvas>
      </div>
      <div class="sector-legend-list" id="sectorLegend"></div>
    </div>
  </div>

  <!-- CATEGORY GRID (hidden, kept for rebuildDashboard compat) -->
  <div class="cat-grid" id="catGrid"></div>

  <!-- HEAT MAP -->
  <div class="heat-section">
    <div class="section-label">Heat map — all holdings by today's move</div>
    <div class="heat-grid" id="heatGrid"></div>
  </div>

  <!-- HISTORICAL TREND (shown after second upload) -->
  <div id="historicalSection" style="display:none; margin-bottom:40px;">
    <div class="section-label">Since last upload</div>
    <div style="background:var(--paper2);border:1px solid var(--rule);padding:16px 20px;" id="historicalContent"></div>
  </div>

  <!-- SUSPENDED -->
  <div class="suspended-banner" id="suspendedBanner"></div>

  <!-- FULL LIST -->
  <div class="list-section">
    <div class="section-label">All holdings — ranked by today's change</div>
    <div class="filter-bar" id="filterBar"></div>
    <div id="barList"></div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="footer-left">91 holdings · 10 sectors</div>
    <div class="footer-right">
      Source: Financial Times portfolio export<br>
      Prices as at close 24 Feb 2026
    </div>
  </div>

  <!-- CSV UPLOADER -->
  <div class="uploader-section">
    <div class="section-label">Update portfolio data</div>
    <div class="uploader-box" id="uploaderBox">
      <input type="file" id="csvInput" >
      <div class="uploader-icon">↑</div>
      <div class="uploader-title">Drop a new FT export here, or click to browse</div>
      <div class="uploader-sub">
        Export from the Financial Times portfolio page as CSV<br>
        Expected columns: Name · Symbol · Last Price · Last Price_Currency · Today's price Change - %
      </div>
      <div class="uploader-status" id="uploaderStatus"></div>
    </div>
  </div>

  <!-- DISCLAIMER -->
  <div class="disclaimer">
    <strong>Important information</strong>
    This website is for informational purposes only and does not constitute personal financial advice.
    All investments can fall in value and you may get back less than you invest.
    Consider consulting a qualified financial adviser before investing.
  </div>

</div>
<script>
const categoryConfig = {
  "Investment Trusts":   { color: "#2d5a3a" },
  "Industrials & Other": { color: "#2d4a6b" },
  "Renewables & Energy": { color: "#1a5a4a" },
  "ETFs":                { color: "#5a5a1a" },
  "Infrastructure":      { color: "#2d4a5a" },
  "Resources & Energy":  { color: "#5a3d1a" },
  "Real Estate":         { color: "#6b3a2d" },
  "Healthcare":          { color: "#6b2d4a" },
  "Asset Managers":      { color: "#5a1a4a" },
  "Banks & Financial":   { color: "#3d2d6b" },
};

const holdings = [{"name":"3i Infrastructure Plc","symbol":"3IN","price":352.5,"currency":"GBX","change":-0.1416,"category":"Infrastructure","suspended":false},{"name":"Aberforth Smaller Companies Trust Plc","symbol":"ASL","price":1676.0,"currency":"GBX","change":0.4796,"category":"Investment Trusts","suspended":false},{"name":"Abrdn Diversified Income & Growth plc","symbol":"ADIG","price":28.6233,"currency":"GBX","change":1.1424,"category":"Investment Trusts","suspended":false},{"name":"Agronomics Ltd","symbol":"ANIC","price":6.4288,"currency":"GBX","change":2.0444,"category":"Resources & Energy","suspended":false},{"name":"Alamos Gold Inc","symbol":"AGI","price":48.63,"currency":"USD","change":-2.1529,"category":"Resources & Energy","suspended":false},{"name":"Artemis UK Future Leaders plc","symbol":"AFL","price":375.0,"currency":"GBX","change":0.0,"category":"Investment Trusts","suspended":false},{"name":"Augmentum Fintech PLC","symbol":"AUGM","price":87.466,"currency":"GBX","change":-0.3804,"category":"Investment Trusts","suspended":false},{"name":"AVI Global Trust PLC","symbol":"AGT","price":266.5,"currency":"GBX","change":0.566,"category":"Investment Trusts","suspended":false},{"name":"AVI Japan Opportunity Trust plc","symbol":"AJOT","price":185.0,"currency":"GBX","change":0.8174,"category":"Investment Trusts","suspended":false},{"name":"Avingtrans PLC","symbol":"AVG","price":580.0,"currency":"GBX","change":0.8696,"category":"Industrials & Other","suspended":false},{"name":"B&M European Value Retail SA","symbol":"BME","price":191.65,"currency":"GBX","change":1.7251,"category":"Industrials & Other","suspended":false},{"name":"B.P. Marsh & Partners PLC","symbol":"BPM","price":690.0,"currency":"GBX","change":2.9851,"category":"Industrials & Other","suspended":false},{"name":"Baillie Gifford Shin Nippon","symbol":"BGS","price":150.6,"currency":"GBX","change":1.6194,"category":"Industrials & Other","suspended":false},{"name":"Barratt Redrow PLC","symbol":"BTRW","price":377.5,"currency":"GBX","change":0.5862,"category":"Real Estate","suspended":false},{"name":"Bellevue Healthcare Trust plc","symbol":"BBH","price":133.6,"currency":"GBX","change":0.4511,"category":"Healthcare","suspended":false},{"name":"BlackRock Smaller Companies Trust","symbol":"BRSC","price":1408.0,"currency":"GBX","change":-0.7052,"category":"Investment Trusts","suspended":false},{"name":"Blue Owl Capital Corp","symbol":"OBDC","price":11.7,"currency":"USD","change":1.6507,"category":"Banks & Financial","suspended":false},{"name":"Bluefield Solar Income Fund Limited","symbol":"BSIF","price":73.5,"currency":"GBX","change":-0.9434,"category":"Renewables & Energy","suspended":false},{"name":"Burford Capital Ltd","symbol":"BUR","price":689.5,"currency":"GBX","change":0.0726,"category":"Investment Trusts","suspended":false},{"name":"Caledonia Investments Plc","symbol":"CLDN","price":340.5,"currency":"GBX","change":-1.4472,"category":"Investment Trusts","suspended":false},{"name":"Chicago Atlantic Real Estate Finance Inc","symbol":"REFI","price":11.8036,"currency":"USD","change":-0.3916,"category":"Real Estate","suspended":false},{"name":"Chrysalis Investments Limited","symbol":"CHRY","price":92.5,"currency":"GBX","change":-0.108,"category":"Investment Trusts","suspended":false},{"name":"Cordiant Digital Infrastructure","symbol":"CORD","price":105.1002,"currency":"GBX","change":0.0954,"category":"Infrastructure","suspended":false},{"name":"CT Automotive Group PLC","symbol":"CTA","price":26.0,"currency":"GBX","change":1.9608,"category":"Industrials & Other","suspended":false},{"name":"CT Private Equity Trust PLC","symbol":"CTPE","price":520.0,"currency":"GBX","change":-0.3831,"category":"Investment Trusts","suspended":false},{"name":"Digital 9 Infrastructure PLC","symbol":"DGI9","price":5.35,"currency":"GBX","change":-0.1866,"category":"Infrastructure","suspended":false},{"name":"Diverse Income Trust","symbol":"DIVI","price":117.875,"currency":"GBX","change":0.3191,"category":"Investment Trusts","suspended":false},{"name":"Dunelm Group PLC","symbol":"DNLM","price":993.0,"currency":"GBX","change":0.8634,"category":"Industrials & Other","suspended":false},{"name":"Ecora Royalties PLC","symbol":"ECOR","price":142.4,"currency":"GBX","change":0.565,"category":"Resources & Energy","suspended":false},{"name":"EKF Diagnostics Holdings PLC","symbol":"EKF","price":25.7022,"currency":"GBX","change":-2.6432,"category":"Healthcare","suspended":false},{"name":"EPE Special Opportunities","symbol":"ESO","price":181.0,"currency":"GBX","change":0.0,"category":"Investment Trusts","suspended":false},{"name":"F&C Investment Trust","symbol":"FCIT","price":1279.982,"currency":"GBX","change":0.786,"category":"Investment Trusts","suspended":false},{"name":"Fevara PLC","symbol":"FVA","price":130.0,"currency":"GBX","change":-1.5152,"category":"Industrials & Other","suspended":false},{"name":"Fidelity Emerging Markets Ltd","symbol":"GG00B4L0PD47","price":1260.0,"currency":"GBX","change":1.4493,"category":"Industrials & Other","suspended":false},{"name":"Finsbury Growth & Income Trust PLC","symbol":"FGT","price":766.82,"currency":"GBX","change":0.8974,"category":"Investment Trusts","suspended":false},{"name":"Flowtech Fluidpower PLC","symbol":"FLO","price":57.0,"currency":"GBX","change":0.5291,"category":"Industrials & Other","suspended":false},{"name":"Foresight Environmental Infrastructure Limited","symbol":"FGEN","price":67.8,"currency":"GBX","change":-0.2941,"category":"Renewables & Energy","suspended":false},{"name":"Foresight Solar Fund Ltd","symbol":"FSFL","price":63.5,"currency":"GBX","change":1.6,"category":"Renewables & Energy","suspended":false},{"name":"Franchise Brands PLC","symbol":"FRAN","price":128.4442,"currency":"GBX","change":-1.1968,"category":"Industrials & Other","suspended":false},{"name":"Frontier IP Group PLC","symbol":"FIPP","price":13.74,"currency":"GBX","change":5.6923,"category":"Industrials & Other","suspended":false},{"name":"Gore Street Energy Storage Fund plc","symbol":"GSF","price":53.3,"currency":"GBX","change":-1.2963,"category":"Renewables & Energy","suspended":false},{"name":"Grainger PLC","symbol":"GRI","price":190.2,"currency":"GBX","change":0.2107,"category":"Real Estate","suspended":false},{"name":"Greencoat UK Wind PLC","symbol":"UKW","price":93.35,"currency":"GBX","change":-0.1604,"category":"Renewables & Energy","suspended":false},{"name":"Hansa Investment Company Ltd","symbol":"HANA","price":282.0,"currency":"GBX","change":-0.7042,"category":"Investment Trusts","suspended":false},{"name":"HarbourVest Global Private Equity","symbol":"HVPE","price":2925.0,"currency":"GBX","change":-2.8239,"category":"Investment Trusts","suspended":false},{"name":"Headlam Group PLC","symbol":"HEAD","price":42.054,"currency":"GBX","change":-0.5816,"category":"Industrials & Other","suspended":false},{"name":"Helical PLC","symbol":"HLCL","price":194.8,"currency":"GBX","change":-1.8145,"category":"Real Estate","suspended":false},{"name":"Henderson Smaller Companies Investment Trust","symbol":"HSL","price":920.87,"currency":"GBX","change":-0.3387,"category":"Investment Trusts","suspended":false},{"name":"Impax Asset Management Group PLC","symbol":"IPX","price":143.4,"currency":"GBX","change":-2.449,"category":"Asset Managers","suspended":false},{"name":"Inchcape PLC","symbol":"INCH","price":881.5,"currency":"GBX","change":1.0894,"category":"Industrials & Other","suspended":false},{"name":"Inspiration Healthcare Group PLC","symbol":"IHC","price":22.0,"currency":"GBX","change":0.9174,"category":"Healthcare","suspended":false},{"name":"International Public Partnerships Limited","symbol":"INPP","price":130.56,"currency":"GBX","change":0.5855,"category":"Infrastructure","suspended":false},{"name":"Invinity Energy Systems PLC","symbol":"IES","price":18.95,"currency":"GBX","change":-0.915,"category":"Renewables & Energy","suspended":false},{"name":"IP Group PLC","symbol":"IPO","price":56.2,"currency":"GBX","change":-0.8818,"category":"Industrials & Other","suspended":false},{"name":"iShares MSCI World Small Cap UCITS ETF","symbol":"WLDS","price":7.308,"currency":"GBP","change":0.7444,"category":"ETFs","suspended":false},{"name":"iShares Physical Silver ETC","symbol":"SSLN","price":6153.0,"currency":"GBX","change":-0.1136,"category":"ETFs","suspended":false},{"name":"iShares S&P SmallCap 600 UCITS ETF","symbol":"ISP6","price":7816.0,"currency":"GBX","change":1.4406,"category":"ETFs","suspended":false},{"name":"John Wood Group PLC","symbol":"WG.","price":26.4816,"currency":"GBX","change":0.2332,"category":"Industrials & Other","suspended":false},{"name":"JPMorgan UK Small Cap Growth & Income","symbol":"JUGI","price":354.0,"currency":"GBX","change":-0.5618,"category":"Investment Trusts","suspended":false},{"name":"JPMorgan US Smaller Companies Investment Trust","symbol":"JUSC","price":413.0,"currency":"GBX","change":0.7317,"category":"Investment Trusts","suspended":false},{"name":"Logistics Development Group PLC","symbol":"LDG","price":15.06,"currency":"GBX","change":-0.5941,"category":"Industrials & Other","suspended":false},{"name":"Lords Group Trading PLC","symbol":"LORD","price":24.175,"currency":"GBX","change":-1.3265,"category":"Industrials & Other","suspended":false},{"name":"Mercia Asset Management PLC","symbol":"MERC","price":29.15,"currency":"GBX","change":-1.1864,"category":"Asset Managers","suspended":false},{"name":"Molten Ventures PLC","symbol":"GROW","price":450.0,"currency":"GBX","change":-1.3158,"category":"Investment Trusts","suspended":false},{"name":"Montanaro UK Smaller Companies Trust","symbol":"MTU","price":104.339,"currency":"GBX","change":0.326,"category":"Investment Trusts","suspended":false},{"name":"NB Private Equity Partners","symbol":"NBPE","price":1388.0,"currency":"GBX","change":-3.4771,"category":"Investment Trusts","suspended":false},{"name":"NextEnergy Solar Ord","symbol":"NESF","price":49.5,"currency":"GBX","change":0.2024,"category":"Renewables & Energy","suspended":false},{"name":"Nexus Infrastructure PLC","symbol":"NEXS","price":118.75,"currency":"GBX","change":1.0638,"category":"Infrastructure","suspended":false},{"name":"North Atlantic Smaller Companies","symbol":"NAS","price":370.0,"currency":"GBX","change":1.0929,"category":"Investment Trusts","suspended":false},{"name":"Octopus Renewables Infrastructure Trust PLC","symbol":"ORIT","price":54.485,"currency":"GBX","change":0.8981,"category":"Renewables & Energy","suspended":false},{"name":"Pinewood Technologies Group PLC","symbol":"PINE","price":302.99,"currency":"GBX","change":-1.3062,"category":"Industrials & Other","suspended":false},{"name":"Plexus Holdings PLC","symbol":"POS","price":5.58,"currency":"GBX","change":-0.8,"category":"Industrials & Other","suspended":false},{"name":"Power Metal Resources PLC","symbol":"POW","price":15.5,"currency":"GBX","change":0.0,"category":"Resources & Energy","suspended":false},{"name":"Rainbow Rare Earths Ltd","symbol":"RBW","price":20.0,"currency":"GBX","change":2.0408,"category":"Resources & Energy","suspended":false},{"name":"RIT Capital Partners","symbol":"RCP","price":2162.0,"currency":"GBX","change":-0.8257,"category":"Investment Trusts","suspended":false},{"name":"Rosslyn Data Technologies PLC","symbol":"RDT","price":2.9,"currency":"GBX","change":0.0,"category":"Industrials & Other","suspended":false},{"name":"Schroder UK Mid Cap","symbol":"SCP","price":753.75,"currency":"GBX","change":0.7687,"category":"Industrials & Other","suspended":false},{"name":"SDCL Efficiency Income Trust","symbol":"SEIT","price":47.554,"currency":"GBX","change":1.1787,"category":"Renewables & Energy","suspended":false},{"name":"Seraphim Space Investment Trust","symbol":"SSIT","price":145.436,"currency":"GBX","change":-3.0427,"category":"Infrastructure","suspended":false},{"name":"Serica Energy PLC","symbol":"SQZ","price":230.8685,"currency":"GBX","change":0.5963,"category":"Resources & Energy","suspended":false},{"name":"Shearwater Group PLC","symbol":"SWG","price":46.58,"currency":"GBX","change":0.172,"category":"Industrials & Other","suspended":false},{"name":"Speedy Hire PLC","symbol":"SDY","price":25.1,"currency":"GBX","change":0.8032,"category":"Industrials & Other","suspended":false},{"name":"State Street SPDR Bloomberg 15+ Year Gilt ETF","symbol":"GLTL","price":36.1,"currency":"GBP","change":0.1943,"category":"ETFs","suspended":false},{"name":"Strategic Equity Capital Plc","symbol":"SEC","price":390.0,"currency":"GBX","change":-0.5102,"category":"Investment Trusts","suspended":false},{"name":"The Renewables Infrastructure Group","symbol":"TRIG","price":65.1,"currency":"GBX","change":1.8779,"category":"Renewables & Energy","suspended":false},{"name":"Trifast PLC","symbol":"TRI","price":84.272,"currency":"GBX","change":4.0395,"category":"Industrials & Other","suspended":false},{"name":"VanEck Rare Earth & Strategic Metals ETF","symbol":"REGB","price":13.502,"currency":"GBP","change":2.9901,"category":"ETFs","suspended":false},{"name":"Vanguard FTSE 250 UCITS ETF","symbol":"VMIG","price":43.765,"currency":"GBP","change":0.0686,"category":"ETFs","suspended":false},{"name":"VH Global Energy Infrastructure PLC","symbol":"ENRG","price":74.862,"currency":"GBX","change":0.3512,"category":"Renewables & Energy","suspended":false},{"name":"Xtrackers S&P 500 Equal Weight ETF","symbol":"XDWE","price":8315.0,"currency":"GBX","change":0.7146,"category":"ETFs","suspended":false},{"name":"Zinc Media Group PLC","symbol":"ZIN","price":44.0,"currency":"GBX","change":-4.3478,"category":"Industrials & Other","suspended":false}];

// ── COMPUTED STATS ────────────────────────────────────────────────────────────
const active = holdings.filter(h => !h.suspended);
const up    = active.filter(h => h.change > 0);
const down  = active.filter(h => h.change < 0);
const flat  = active.filter(h => h.change === 0);
const suspended = holdings.filter(h => h.suspended);
const maxGain = Math.max(...active.map(h => h.change));
const maxLoss = Math.min(...active.map(h => h.change));
const avgChange = active.reduce((a,h)=>a+h.change,0)/active.length;

// ── SUBTITLE ─────────────────────────────────────────────────────────────────
document.getElementById('subtitleRight').innerHTML =
  `${up.length} rising &nbsp;·&nbsp; ${down.length} falling &nbsp;·&nbsp; ${flat.length} unchanged`;

// ── SCORECARD ────────────────────────────────────────────────────────────────
const scoreData = [
  { label: 'Total Holdings',  val: 180,                    cls: 'neutral', sub: `${suspended.length} suspended` },
  { label: 'Rising Today',    val: up.length,              cls: 'up',      sub: `${(up.length/active.length*100).toFixed(0)}% of active` },
  { label: 'Falling Today',   val: down.length,            cls: 'down',    sub: `${(down.length/active.length*100).toFixed(0)}% of active` },
  { label: 'Best Mover',      val: `+${maxGain.toFixed(2)}%`, cls: 'up',  sub: active.find(h=>h.change===maxGain)?.symbol },
  { label: 'Worst Mover',     val: `${maxLoss.toFixed(2)}%`,  cls: 'down',sub: active.find(h=>h.change===maxLoss)?.symbol },
];
const sc = document.getElementById('scorecard');
scoreData.forEach(s => {
  sc.innerHTML += `<div class="score-cell">
    <div class="score-cell-label">${s.label}</div>
    <div class="score-cell-val ${s.cls}">${s.val}</div>
    <div class="score-cell-sub">${s.sub}</div>
  </div>`;
});

// ── MOSAIC STRIP ─────────────────────────────────────────────────────────────
const catCounts = {};
holdings.forEach(h => { catCounts[h.category] = (catCounts[h.category]||0)+1; });
const totalCount = holdings.length;

const strip = document.getElementById('mosaicStrip');
const legendEl = document.getElementById('legendStrip');
Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).forEach(([cat, count]) => {
  const cfg = categoryConfig[cat] || { color: '#888' };
  const pct = count / totalCount * 100;
  const seg = document.createElement('div');
  seg.className = 'mosaic-seg';
  seg.style.cssText = `width:${pct}%; background:${cfg.color}; opacity:0.85`;
  seg.setAttribute('data-label', `${cat} · ${count} holdings`);
  strip.appendChild(seg);

  const li = document.createElement('div');
  li.className = 'legend-item';
  li.innerHTML = `<div class="legend-swatch" style="background:${cfg.color}"></div>${cat}`;
  legendEl.appendChild(li);
});

// ── SECTOR DOUGHNUT CHART ─────────────────────────────────────────────────────
const SECTOR_PALETTE = [
  '#2d5a3a','#2d4a6b','#1a5a4a','#5a5a1a','#2d4a5a',
  '#5a3d1a','#6b3a2d','#6b2d4a','#5a1a4a','#3d2d6b','#4a5a2d'
];

let sectorChartInstance = null;

function renderSectorChart(holdingsData) {
  const counts = {};
  holdingsData.forEach(h => { counts[h.category] = (counts[h.category]||0)+1; });
  const labels = Object.keys(counts).sort((a,b) => counts[b]-counts[a]);
  const data   = labels.map(l => counts[l]);
  const total  = holdingsData.length;
  const colors = SECTOR_PALETTE.slice(0, labels.length);

  if (sectorChartInstance) sectorChartInstance.destroy();

  const ctx = document.getElementById('sectorChart').getContext('2d');
  sectorChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: '#f5f0e8',
        hoverBorderWidth: 3,
      }]
    },
    options: {
      cutout: '62%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.label}: ${ctx.raw} holdings (${(ctx.raw/total*100).toFixed(1)}%)`
          },
          bodyFont: { family: 'Outfit', size: 12 },
          padding: 10
        }
      },
      responsive: true,
      maintainAspectRatio: true,
    }
  });

  // Custom legend
  const legend = document.getElementById('sectorLegend');
  if (legend) {
    legend.innerHTML = labels.map((l,i) => {
      const catHoldings = holdingsData.filter(h => h.category === l && !h.suspended);
      const catUp   = catHoldings.filter(h => h.change > 0).length;
      const catDown = catHoldings.filter(h => h.change < 0).length;
      return `<div class="sector-legend-item">
        <div class="sector-legend-swatch" style="background:${colors[i]}"></div>
        <div class="sector-legend-name">${l}</div>
        <div class="sector-legend-detail" style="color:var(--muted)">
          ${data[i]} &nbsp;
          <span style="color:var(--up)">▲${catUp}</span>
          <span style="color:var(--down)">▼${catDown}</span>
        </div>
      </div>`;
    }).join('');
  }
}

renderSectorChart(holdings);
Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).forEach(([cat, count]) => {
  const cfg = categoryConfig[cat] || { color: '#888' };
  const catHoldings = active.filter(h=>h.category===cat);
  const catUp = catHoldings.filter(h=>h.change>0).length;
  const catDown = catHoldings.filter(h=>h.change<0).length;
  catGrid.innerHTML += `<div class="cat-cell">
    <div class="cat-swatch" style="background:${cfg.color}"></div>
    <div class="cat-name">${cat}</div>
    <div class="cat-count">${count}<span> holdings</span></div>
    <div class="cat-move" style="color:${catUp>catDown?'var(--up)':'var(--down)'}">▲ ${catUp} &nbsp; ▼ ${catDown}</div>
  </div>`;
});

// ── MOVERS ────────────────────────────────────────────────────────────────────
const sortedActive = [...active].sort((a,b) => b.change - a.change);
const top10 = sortedActive.slice(0, 10);
const bot10 = sortedActive.slice(-10).reverse();

function moverRow(h, cls) {
  return `<div class="mover-row">
    <div class="mover-name">${h.name.replace(' PLC','').replace(' plc','').replace(' Limited','').replace(' Group','')}<span class="mover-sym">${h.symbol} · ${h.category}</span></div>
    <div class="mover-pct ${cls}">${cls==='up'?'+':''}${h.change.toFixed(2)}%</div>
  </div>`;
}

const gainersEl = document.getElementById('gainers');
const losersEl  = document.getElementById('losers');
top10.forEach(h => gainersEl.innerHTML += moverRow(h,'up'));
bot10.forEach(h => losersEl.innerHTML  += moverRow(h,'down'));

// ── HEAT MAP — lazy loaded ────────────────────────────────────────────────────
const heatGrid = document.getElementById('heatGrid');
const heatSection = document.querySelector('.heat-section');

// Skeleton placeholder until visible
heatGrid.innerHTML = '<div style="height:120px;background:repeating-linear-gradient(90deg,rgba(200,191,170,0.15) 0,rgba(200,191,170,0.08) 50%,rgba(200,191,170,0.15) 100%);background-size:200% 100%;animation:shimmer 1.4s linear infinite;border-radius:2px;"></div>';

const shimmerStyle = document.createElement('style');
shimmerStyle.textContent = '@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}';
document.head.appendChild(shimmerStyle);

function buildHeatmap(holdingsData) {
  heatGrid.innerHTML = '';
  const heatSorted = [...holdingsData.filter(h => !h.suspended)].sort((a,b) => b.change - a.change);
  const absMax = Math.max(...heatSorted.map(h => Math.abs(h.change)), 0.001);
  const isMobile = window.innerWidth <= 600;

  heatSorted.forEach(h => {
    const intensity = Math.abs(h.change) / absMax;
    let bg;
    if (h.change > 0) {
      const g = Math.round(50 + intensity * 80);
      bg = `rgba(30,${g+60},50,${0.3+intensity*0.65})`;
    } else if (h.change < 0) {
      const r = Math.round(120 + intensity * 80);
      bg = `rgba(${r},30,30,${0.3+intensity*0.65})`;
    } else {
      bg = 'rgba(150,140,120,0.25)';
    }

    const size = isMobile ? null : 44;
    const cell = document.createElement('div');
    cell.className = 'heat-cell';
    if (!isMobile) cell.style.cssText = `background:${bg}; width:${size}px; height:${size}px;`;
    else cell.style.cssText = `background:${bg};`;

    const symStr = h.symbol.length > 5 ? h.symbol.slice(0,5) : h.symbol;
    const chgStr = `${h.change >= 0 ? '+' : ''}${h.change.toFixed(2)}%`;
    cell.innerHTML = `<span class="heat-sym">${symStr}</span>${isMobile ? `<span class="heat-pct">${chgStr}</span>` : ''}`;

    // Rich tooltip
    cell.addEventListener('mouseenter', e => {
      const tt = document.getElementById('heatTooltip');
      document.getElementById('ht-sym').textContent = h.symbol;
      document.getElementById('ht-name').textContent = h.name.replace(' PLC','').replace(' plc','').replace(' Limited','');
      const pctEl = document.getElementById('ht-pct');
      pctEl.textContent = chgStr;
      pctEl.className = 'ht-pct ' + (h.change > 0 ? 'up' : h.change < 0 ? 'down' : '');
      document.getElementById('ht-price').textContent = h.price ? `${h.price.toFixed(2)} ${h.currency}` : '';
      document.getElementById('ht-cat').textContent = h.category;
      tt.classList.add('visible');
      positionHeatTip(e);
    });
    cell.addEventListener('mousemove', positionHeatTip);
    cell.addEventListener('mouseleave', () => {
      document.getElementById('heatTooltip').classList.remove('visible');
    });

    heatGrid.appendChild(cell);
  });
}

function positionHeatTip(e) {
  const tt = document.getElementById('heatTooltip');
  const tw = 180, th = 110;
  let x = e.clientX + 14, y = e.clientY - 16;
  if (x + tw > window.innerWidth)  x = e.clientX - tw - 14;
  if (y + th > window.innerHeight) y = e.clientY - th - 10;
  tt.style.left = x + 'px';
  tt.style.top  = y + 'px';
}

// IntersectionObserver for lazy loading
const heatObserver = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting) {
    buildHeatmap(holdings);
    heatObserver.disconnect();
  }
}, { rootMargin: '200px' });
heatObserver.observe(heatSection);

// ── SUSPENDED BANNER ─────────────────────────────────────────────────────────
const susp = document.getElementById('suspendedBanner');
susp.innerHTML = `<strong>⚠ ${suspended.length} suspended / delisted holdings:</strong>  ` +
  suspended.map(h => `${h.name} (${h.symbol})`).join(' · ');

// ── FULL LIST WITH FILTER ─────────────────────────────────────────────────────
const categories = ['All', ...Object.keys(catCounts).sort((a,b)=>catCounts[b]-catCounts[a])];
const filterBar = document.getElementById('filterBar');
let activeFilter = 'All';

function renderList() {
  const barList = document.getElementById('barList');
  barList.innerHTML = '';
  const filtered = activeFilter === 'All'
    ? [...holdings].sort((a,b) => b.change - a.change)
    : [...holdings].filter(h=>h.category===activeFilter).sort((a,b)=>b.change-a.change);

  const maxChg = Math.max(...filtered.map(h=>Math.abs(h.change)), 0.01);

  filtered.forEach((h, i) => {
    const cfg = categoryConfig[h.category] || { color:'#888' };
    const chgCls = h.change > 0 ? 'up' : h.change < 0 ? 'down' : 'flat';
    const chgStr = h.change > 0 ? `+${h.change.toFixed(2)}%` : h.change < 0 ? `${h.change.toFixed(2)}%` : '—';
    const barW = (Math.abs(h.change) / maxChg * 100).toFixed(1);
    const shortName = h.name.length > 36 ? h.name.slice(0,34) + '…' : h.name;
    const suspFlag = h.suspended ? ' <span style="font-size:12px;color:var(--down);letter-spacing:0.04em;text-transform:uppercase">suspended</span>' : '';

    const row = document.createElement('div');
    row.className = 'bar-row';
    row.style.animationDelay = `${Math.min(i,40) * 12}ms`;
    row.innerHTML = `
      <div class="rank-num">${i+1}</div>
      <div class="bar-name">${shortName}${suspFlag}<span class="sym">${h.symbol} · ${h.category}</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:${barW}%; background:${h.change>0?'var(--up)':h.change<0?'var(--down)':'var(--flat)'}; opacity:0.75;"></div></div>
      <div class="bar-chg ${chgCls}">${chgStr}</div>`;
    barList.appendChild(row);
  });
}

categories.forEach(cat => {
  const btn = document.createElement('button');
  btn.className = 'filter-btn' + (cat === 'All' ? ' active' : '');
  btn.textContent = cat === 'All' ? `All (${holdings.length})` : `${cat} (${catCounts[cat]})`;
  btn.onclick = () => {
    activeFilter = cat;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderList();
  };
  filterBar.appendChild(btn);
});

renderList();

// ── CSV UPLOADER ──────────────────────────────────────────────────────────────
function categorise(name) {
  const n = name.toLowerCase();
  if (/reit|real estate|grainger|helical|barratt|springfield|schroder real estate|henry boot|mj gleeson|taylor wimpey|persimmon|chicago atlantic/.test(n)) return 'Real Estate';
  if (/solar|wind|renewable|greencoat|trig|foresight|nextenergy|gore street|gresham house energy|octopus renewables|sdcl|aquila|bluefield|invinity|vh global energy/.test(n)) return 'Renewables & Energy';
  if (/infrastructure|3i infra|cordiant|digital 9|inpp|international public partnerships|nexus infra|seraphim/.test(n)) return 'Infrastructure';
  if (/lloyds|barclays|natwest|aib|close brothers|blue owl/.test(n)) return 'Banks & Financial';
  if (/investment trust|private equity|harbourvest|ct private equity|nbpe|nb private equity|avi global|avi japan|aberforth|blackrock smaller|henderson smaller|jpmorgan|montanaro|north atlantic|caledonia|hansa|chrysalis|finsbury|f&c investment|rit capital|strategic equity|artemis uk future|augmentum|epe special|diverse income|burford|abrdn diversified|molten/.test(n)) return 'Investment Trusts';
  if (/\betf\b|ishares|vaneck|vanguard|xtrackers|spdr|state street/.test(n)) return 'ETFs';
  if (/ecora|serica|agronomics|rainbow rare|power metal|alamos gold/.test(n)) return 'Resources & Energy';
  if (/bellevue|ekf|inspiration healthcare/.test(n)) return 'Healthcare';
  if (/impax|mercia asset/.test(n)) return 'Asset Managers';
  return 'Industrials & Other';
}

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) throw new Error('File appears empty');
  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,''));
  const nameIdx   = headers.findIndex(h => h === 'Name');
  const symIdx    = headers.findIndex(h => h === 'Symbol');
  const priceIdx  = headers.findIndex(h => h === 'Last Price');
  const curIdx    = headers.findIndex(h => h === 'Last Price_Currency');
  const chgIdx    = headers.findIndex(h => h.includes("Today's price Change"));
  if ([nameIdx, symIdx, priceIdx, curIdx, chgIdx].includes(-1))
    throw new Error('Missing expected columns. Please use an FT portfolio CSV export.');

  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g,''));
    const name = cols[nameIdx] || '';
    const sym  = (cols[symIdx] || '').split(':')[0];
    const price = parseFloat(cols[priceIdx]) || 0;
    const currency = cols[curIdx] || 'GBX';
    const change = parseFloat(cols[chgIdx]) || 0;
    const suspended = name.endsWith('*');
    rows.push({ name: name.replace(/\s*\*$/, ''), symbol: sym, price, currency, change,
                category: categorise(name), suspended });
  }
  if (rows.length === 0) throw new Error('No data rows found in file.');
  return rows;
}

function rebuildDashboard(newHoldings) {
  // Update masthead date
  const today = new Date();
  const dateStr = today.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  const timeStr = today.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  document.getElementById('mastheadMeta').innerHTML =
    `${newHoldings.length} Holdings · LSE<br>Price data: FT<br>${dateStr}<div class="last-updated-badge" id="lastUpdatedBadge">Loaded ${timeStr} · FT export</div>`;

  // Scorecard
  const act = newHoldings.filter(h => !h.suspended);
  const up2 = act.filter(h => h.change > 0);
  const dn2 = act.filter(h => h.change < 0);
  const fl2 = act.filter(h => h.change === 0);
  const mg  = Math.max(...act.map(h => h.change));
  const ml  = Math.min(...act.map(h => h.change));
  document.getElementById('subtitleRight').innerHTML =
    `${up2.length} rising &nbsp;·&nbsp; ${dn2.length} falling &nbsp;·&nbsp; ${fl2.length} unchanged`;

  const sc = document.getElementById('scorecard');
  sc.innerHTML = '';
  [
    { label: 'Total Holdings',  val: newHoldings.length, cls: 'neutral', sub: `${newHoldings.filter(h=>h.suspended).length} suspended` },
    { label: 'Rising Today',    val: up2.length,          cls: 'up',      sub: `${(up2.length/act.length*100).toFixed(0)}% of active` },
    { label: 'Falling Today',   val: dn2.length,          cls: 'down',    sub: `${(dn2.length/act.length*100).toFixed(0)}% of active` },
    { label: 'Best Mover',      val: `+${mg.toFixed(2)}%`, cls: 'up',    sub: act.find(h=>h.change===mg)?.symbol },
    { label: 'Worst Mover',     val: `${ml.toFixed(2)}%`,  cls: 'down',  sub: act.find(h=>h.change===ml)?.symbol },
  ].forEach(s => {
    sc.innerHTML += `<div class="score-cell"><div class="score-cell-label">${s.label}</div><div class="score-cell-val ${s.cls}">${s.val}</div><div class="score-cell-sub">${s.sub||''}</div></div>`;
  });

  // Mosaic
  const cc = {};
  newHoldings.forEach(h => { cc[h.category] = (cc[h.category]||0)+1; });
  const strip2 = document.getElementById('mosaicStrip');
  strip2.innerHTML = '';
  const leg2 = document.getElementById('legendStrip');
  leg2.innerHTML = '';
  Object.entries(cc).sort((a,b)=>b[1]-a[1]).forEach(([cat,count]) => {
    const cfg = categoryConfig[cat]||{color:'#888'};
    const pct = count/newHoldings.length*100;
    const s = document.createElement('div');
    s.className='mosaic-seg'; s.style.cssText=`width:${pct}%;background:${cfg.color};opacity:0.85`;
    s.setAttribute('data-label',`${cat} · ${count}`); strip2.appendChild(s);
    const li=document.createElement('div'); li.className='legend-item';
    li.innerHTML=`<div class="legend-swatch" style="background:${cfg.color}"></div>${cat}`; leg2.appendChild(li);
  });

  // Category grid (hidden)
  const cg = document.getElementById('catGrid'); cg.innerHTML='';
  Object.entries(cc).sort((a,b)=>b[1]-a[1]).forEach(([cat,count]) => {
    const cfg=categoryConfig[cat]||{color:'#888'};
    const ch=act.filter(h=>h.category===cat);
    const cu=ch.filter(h=>h.change>0).length, cd=ch.filter(h=>h.change<0).length;
    cg.innerHTML+=`<div class="cat-cell"><div class="cat-swatch" style="background:${cfg.color}"></div><div class="cat-name">${cat}</div><div class="cat-count">${count}<span> holdings</span></div><div class="cat-move" style="color:${cu>cd?'var(--up)':'var(--down)'}">▲ ${cu} &nbsp; ▼ ${cd}</div></div>`;
  });

  // Sector chart
  renderSectorChart(newHoldings);

  // Movers
  const sorted2 = [...act].sort((a,b)=>b.change-a.change);
  const ge=document.getElementById('gainers'); ge.innerHTML='';
  const le=document.getElementById('losers');  le.innerHTML='';
  sorted2.slice(0,10).forEach(h => ge.innerHTML+=moverRow(h,'up'));
  sorted2.slice(-10).reverse().forEach(h => le.innerHTML+=moverRow(h,'down'));

  // Heatmap
  buildHeatmap(newHoldings);

  // Suspended
  const susp2=newHoldings.filter(h=>h.suspended);
  document.getElementById('suspendedBanner').innerHTML = susp2.length
    ? `<strong>⚠ ${susp2.length} suspended / delisted holdings:</strong>  `+susp2.map(h=>`${h.name} (${h.symbol})`).join(' · ')
    : '';

  // Footer
  document.querySelector('.footer-left').textContent=`${newHoldings.length} holdings · ${Object.keys(cc).length} sectors`;
  document.querySelector('.footer-right').innerHTML=`Source: Financial Times portfolio export<br>Prices as at ${dateStr}`;

  // List
  const fb=document.getElementById('filterBar'); fb.innerHTML='';
  const cats2=['All',...Object.keys(cc).sort((a,b)=>cc[b]-cc[a])];
  activeFilter='All';
  cats2.forEach(cat=>{
    const btn=document.createElement('button');
    btn.className='filter-btn'+(cat==='All'?' active':'');
    btn.textContent=cat==='All'?`All (${newHoldings.length})`:`${cat} (${cc[cat]})`;
    btn.onclick=()=>{
      activeFilter=cat;
      document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // re-render with new data
      const fb2=document.getElementById('barList'); fb2.innerHTML='';
      const filtered=activeFilter==='All'?[...newHoldings].sort((a,b)=>b.change-a.change):[...newHoldings].filter(h=>h.category===activeFilter).sort((a,b)=>b.change-a.change);
      const mx=Math.max(...filtered.map(h=>Math.abs(h.change)),0.01);
      filtered.forEach((h,i)=>{
        const cfg2=categoryConfig[h.category]||{color:'#888'};
        const cc2=h.change>0?'up':h.change<0?'down':'flat';
        const cs=h.change>0?`+${h.change.toFixed(2)}%`:h.change<0?`${h.change.toFixed(2)}%`:'—';
        const bw=(Math.abs(h.change)/mx*100).toFixed(1);
        const sn=h.name.length>36?h.name.slice(0,34)+'…':h.name;
        const sf=h.suspended?` <span style="font-size:12px;color:var(--down);letter-spacing:0.04em;text-transform:uppercase">suspended</span>`:'';
        const row=document.createElement('div'); row.className='bar-row'; row.style.animationDelay=`${Math.min(i,40)*12}ms`;
        row.innerHTML=`<div class="rank-num">${i+1}</div><div class="bar-name">${sn}${sf}<span class="sym">${h.symbol} · ${h.category}</span></div><div class="bar-track"><div class="bar-fill" style="width:${bw}%;background:${h.change>0?'var(--up)':h.change<0?'var(--down)':'var(--flat)'};opacity:0.75;"></div></div><div class="bar-chg ${cc2}">${cs}</div>`;
        fb2.appendChild(row);
      });
    };
    fb.appendChild(btn);
  });

  // Trigger 'All' render with new data
  const allBtn = fb.querySelector('.filter-btn');
  if (allBtn) {
    const bl=document.getElementById('barList'); bl.innerHTML='';
    const filtered=[...newHoldings].sort((a,b)=>b.change-a.change);
    const mx=Math.max(...filtered.map(h=>Math.abs(h.change)),0.01);
    filtered.forEach((h,i)=>{
      const cc2=h.change>0?'up':h.change<0?'down':'flat';
      const cs=h.change>0?`+${h.change.toFixed(2)}%`:h.change<0?`${h.change.toFixed(2)}%`:'—';
      const bw=(Math.abs(h.change)/mx*100).toFixed(1);
      const sn=h.name.length>36?h.name.slice(0,34)+'…':h.name;
      const sf=h.suspended?` <span style="font-size:12px;color:var(--down);letter-spacing:0.04em;text-transform:uppercase">suspended</span>`:'';
      const row=document.createElement('div'); row.className='bar-row'; row.style.animationDelay=`${Math.min(i,40)*12}ms`;
      row.innerHTML=`<div class="rank-num">${i+1}</div><div class="bar-name">${sn}${sf}<span class="sym">${h.symbol} · ${h.category}</span></div><div class="bar-track"><div class="bar-fill" style="width:${bw}%;background:${h.change>0?'var(--up)':h.change<0?'var(--down)':'var(--flat)'};opacity:0.75;"></div></div><div class="bar-chg ${cc2}">${cs}</div>`;
      bl.appendChild(row);
    });
  }
}

// ── LOCAL STORAGE — save & historical comparison ──────────────────────────────
function saveToStorage(holdingsData) {
  try {
    localStorage.setItem('sipp_previous', JSON.stringify(holdingsData));
    localStorage.setItem('sipp_previous_date', new Date().toISOString());
  } catch(e) {}
}

function loadPrevious() {
  try {
    const raw = localStorage.getItem('sipp_previous');
    const date = localStorage.getItem('sipp_previous_date');
    return raw ? { data: JSON.parse(raw), date } : null;
  } catch(e) { return null; }
}

function renderHistorical(newHoldings) {
  const prev = loadPrevious();
  if (!prev) return;

  const section = document.getElementById('historicalSection');
  const content = document.getElementById('historicalContent');
  if (!section || !content) return;

  const prevMap = {};
  prev.data.forEach(h => { prevMap[h.symbol] = h.change; });

  const changes = newHoldings
    .filter(h => !h.suspended && prevMap[h.symbol] !== undefined)
    .map(h => ({ ...h, prevChange: prevMap[h.symbol], diff: h.change - prevMap[h.symbol] }));

  if (!changes.length) return;

  const improved = changes.filter(h => h.diff > 0.01).length;
  const worsened = changes.filter(h => h.diff < -0.01).length;
  const maxAbsDiff = Math.max(...changes.map(h => Math.abs(h.diff)), 0.001);
  const top3 = [...changes].sort((a,b) => b.diff - a.diff).slice(0, 3);
  const bot3 = [...changes].sort((a,b) => a.diff - b.diff).slice(0, 3);

  const prevDate = new Date(prev.date);
  const prevDateStr = prevDate.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
  const prevTimeStr = prevDate.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });

  content.innerHTML = `
    <div style="font-size:12px;letter-spacing:0.07em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;">
      Compared to upload on ${prevDateStr} at ${prevTimeStr} ·
      <span style="color:var(--up)">${improved} improved</span> ·
      <span style="color:var(--down)">${worsened} weakened</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <div>
        <div style="font-size:12px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Most improved</div>
        ${top3.map(h => `
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:7px;">
            <div style="width:70px;font-family:'Cormorant Garamond',serif;font-size:14px;">${h.symbol}</div>
            <div style="flex:1;height:5px;background:var(--paper);border-radius:2px;overflow:hidden;">
              <div style="width:${(h.diff/maxAbsDiff*100).toFixed(0)}%;height:100%;background:var(--up);border-radius:2px;opacity:0.8;"></div>
            </div>
            <div style="font-size:12px;color:var(--up);width:52px;text-align:right;font-family:'Cormorant Garamond',serif;">+${h.diff.toFixed(2)}%</div>
          </div>`).join('')}
      </div>
      <div>
        <div style="font-size:12px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Most weakened</div>
        ${bot3.map(h => `
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:7px;">
            <div style="width:70px;font-family:'Cormorant Garamond',serif;font-size:14px;">${h.symbol}</div>
            <div style="flex:1;height:5px;background:var(--paper);border-radius:2px;overflow:hidden;">
              <div style="width:${(Math.abs(h.diff)/maxAbsDiff*100).toFixed(0)}%;height:100%;background:var(--down);border-radius:2px;opacity:0.8;"></div>
            </div>
            <div style="font-size:12px;color:var(--down);width:52px;text-align:right;font-family:'Cormorant Garamond',serif;">${h.diff.toFixed(2)}%</div>
          </div>`).join('')}
      </div>
    </div>`;

  section.style.display = 'block';
}

// ── Wire up the uploader
const csvInput = document.getElementById('csvInput');
const uploaderBox = document.getElementById('uploaderBox');
const uploaderStatus = document.getElementById('uploaderStatus');

csvInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  handleFile(file);
});

uploaderBox.addEventListener('dragover', e => { e.preventDefault(); uploaderBox.classList.add('drag-over'); });
uploaderBox.addEventListener('dragleave', () => uploaderBox.classList.remove('drag-over'));
uploaderBox.addEventListener('drop', e => {
  e.preventDefault();
  uploaderBox.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});

function handleFile(file) {
  if (false && !file.name.endsWith('.csv')) {
    uploaderStatus.textContent = '✕ Please upload a .csv file';
    uploaderStatus.className = 'uploader-status err';
    return;
  }
  uploaderStatus.textContent = 'Reading file…';
  uploaderStatus.className = 'uploader-status';
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const newHoldings = parseCSV(ev.target.result);
      uploaderStatus.textContent = `✓ Loaded ${newHoldings.length} holdings from ${file.name}`;
      uploaderStatus.className = 'uploader-status ok';
      renderHistorical(newHoldings);
      saveToStorage(newHoldings);
      rebuildDashboard(newHoldings);
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
      uploaderStatus.textContent = `✕ ${err.message}`;
      uploaderStatus.className = 'uploader-status err';
    }
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
